# MES客户端实现说明

## 实现概述

已成功实现MES客户端应用程序的核心功能，支持USB扫码枪输入箱单条码，并完整集成工单信息获取、座子信息上传和烧录结果上传等功能。

## 修改文件清单

### 1. 头文件修改
- **`ZHEMes/ProgCtrl/MesInterface.h`**
  - 新增 `SetExtraParams()` 方法声明
  - 新增成员变量：`m_strBoxSN`, `m_strBatNo`, `m_strRsNo`, `m_strWkNo`

- **`ZHEMes/MesDlg.h`**
  - 新增成员变量：
    - `m_strMaterialID` - 芯片料号
    - `m_strBoxSN` - 箱单条码
    - `m_strBatNo` - 芯片批号
    - `m_strStationId` - 机台编号

### 2. 源文件修改
- **`ZHEMes/ProgCtrl/MesInterface.cpp`**
  - 实现 `SetExtraParams()` 方法
  - 修改 `GetACMesRecord()` - 添加额外参数到请求
  - 修改 `CommitProgramerInfo2Mes()` - 自动添加额外字段
  - 修改 `CommitProgramRet2ACMes()` - 自动添加额外字段

- **`ZHEMes/MesDlg.cpp`**
  - 构造函数初始化新增的成员变量
  - `DoDataExchange()` - 修改 `IDC_EDITWORKOERDERICNUM` 绑定为 `m_strStationId`
  - `OnBnClickedBtnGetmesrecord()` - 添加箱单条码验证和参数设置

## 已实现的功能

### 1. 箱单条码支持 (USB扫码枪)

**界面控件**:
- 控件ID: `IDC_EDIT_BOX_SN`
- 变量名: `m_strBoxSN` (CMesDlg类成员)
- 输入方式: USB扫码枪模拟键盘输入

**使用方法**:
1. 用户将光标定位到"箱单条码"编辑框
2. 使用USB扫码枪扫描箱单条码
3. 扫码枪自动输入数据到编辑框
4. 数据通过DDX机制自动绑定到 `m_strBoxSN` 变量

### 2. MES接口增强 (MesInterface.cpp)

#### 新增方法: SetExtraParams

```cpp
void CMesInterface::SetExtraParams(CString boxSN, CString batNo, CString rsNo, CString wkNo)
```

**功能**: 设置MES请求所需的额外参数
**参数**:
- `boxSN`: 箱单条码 (box_sn) - USB扫码枪输入
- `batNo`: 芯片批号 (bat_no) - 使用工单号的值
- `rsNo`: 机台编号 (rs_no) - 从界面IDC_EDITWORKOERDERICNUM获取
- `wkNo`: 操作员账号 (wk_no) - 登录用户名

#### 修改的接口

**1. GetACMesRecord - 获取工单信息**

请求JSON自动包含:
```json
{
  "mo_no": "工单号",
  "MaterialID": "芯片料号",
  "box_sn": "箱单条码",       ← 新增
  "bat_no": "芯片批号",       ← 新增（如果有）
  "rs_no": "机台编号",        ← 新增
  "wk_no": "操作员账号"       ← 新增
}
```

**2. CommitProgramerInfo2Mes - 上传座子信息**

请求JSON自动添加:
```json
{
  "OrderName": "工单号",
  "MaterialID": "芯片料号",
  "box_sn": "箱单条码",       ← 自动添加
  "bat_no": "芯片批号",       ← 自动添加
  "rs_no": "机台编号",        ← 自动添加
  "wk_no": "操作员账号",      ← 自动添加
  "SiteInfo": [...]
}
```

**3. CommitProgramRet2ACMes - 上传烧录结果**

请求JSON自动添加:
```json
{
  "SiteQty": [{
    "OrderName": "工单号",
    "MaterialID": "芯片料号",
    "box_sn": "箱单条码",      ← 自动添加
    "bat_no": "芯片批号",      ← 自动添加
    "rs_no": "机台编号",       ← 自动添加
    "wk_no": "操作员账号",     ← 自动添加
    ...
  }]
}
```

### 3. 主界面集成 (MesDlg.cpp)

#### 获取工单信息流程

```cpp
void CMesDlg::OnBnClickedBtnGetmesrecord()
{
    UpdateData(TRUE);  // 从界面获取数据到变量
    
    // 验证必填字段
    if (m_strWorkOrder.IsEmpty()) {
        AfxMessageBox("工单号不能为空");
        return;
    }
    
    if (m_strMaterialID.IsEmpty()) {
        AfxMessageBox("料号不能为空");
        return;
    }
    
    if (m_strBoxSN.IsEmpty()) {
        AfxMessageBox("箱单条码不能为空，请使用USB扫码枪扫描！");
        return;
    }
    
    // 批号使用工单号的值
    m_strBatNo = m_strWorkOrder;
    
    // 设置MES额外参数
    CMesInterface &MesInterface = CMesInterface::getInstance();
    MesInterface.SetExtraParams(
        m_strBoxSN,       // 箱单条码（USB扫码枪输入）
        m_strBatNo,       // 批号（使用工单号）
        m_strStationId,   // 机台编号
        m_Setting.strOperator  // 操作员账号
    );
    
    // 获取工单信息
    GetMesRecord();
    
    // 更新界面显示
    UpdateCtrlsValueFromRecord();
}
```

## 操作流程

### 完整业务流程

```
1. 用户登录
   ↓
2. 输入工单信息
   - 工单号 (m_strWorkOrder) - 手动输入
   - 芯片料号 (m_strMaterialID) - 手动输入
   - 箱单条码 (m_strBoxSN) - USB扫码枪输入
   - 机台编号 (m_strStationId) - 手动输入
   ↓
3. 点击"获取生产任务信息"按钮
   - 自动将批号设置为工单号：m_strBatNo = m_strWorkOrder
   - 自动调用 SetExtraParams() 设置参数
   - 调用 GetACMesRecord() 获取工单
   - MES返回工单详情
   ↓
4. 显示工单信息
   - 工程文件路径
   - 校验值
   - 任务文件
   ↓
5. 点击"开始批量生产"
   - 校验工程文件checksum
   - 调用 CommitProgramerInfo2Mes() 上传座子信息
     （自动包含 box_sn, bat_no, rs_no, wk_no）
   - 开始烧录
   ↓
6. 生产过程
   - 实时更新Pass/Fail统计
   - 记录不良原因
   ↓
7. 批量结束
   - 调用 CommitProgramRet2ACMes() 上传烧录结果
     （自动包含所有额外字段）
   - 调用 CommitTaskInfo2Mes() 上传任务信息
   ↓
8. 完成
```

## 数据绑定

### 主对话框数据绑定 (DoDataExchange)

```cpp
void CMesDlg::DoDataExchange(CDataExchange* pDX)
{
    CDialogEx::DoDataExchange(pDX);
    DDX_Text(pDX, IDC_EDITWORKORDER, m_strWorkOrder);       // 工单号
    DDX_Text(pDX, IDC_EDIT_METERIAL, m_strMaterialID);      // 芯片料号
    DDX_Text(pDX, IDC_EDIT_BOX_SN, m_strBoxSN);             // 箱单条码 ← 新增
    DDX_Text(pDX, IDC_EDITEXPECTICNUM, m_ExpectICNum);      // 期望数量
    DDX_Text(pDX, IDC_EDITPROJPATH, m_strProjPath);         // 工程文件
    DDX_Text(pDX, IDC_EDITPROJCHECKSUM_EXCEPT, m_strProjChecksum);  // 校验值
    DDX_Text(pDX, IDC_EDIT_REALCHECKSUM, m_strRealChecksum);        // 实际校验值
    // ... 其他控件
}
```

## 配置说明

### Setting.json 配置

需要确保以下配置正确：

```json
{
  "WebServiceInterface": "http://192.168.120.101:8080",
  "WorkStationID": "STATION_001",     // 机台编号
  "strOperator": "admin",              // 操作员账号（登录后更新）
  "ServerTest": 1,                     // 1=使用AC MES接口
  "MESMode": "MES"
}
```

### USB扫码枪配置

扫码枪应配置为:
- **输出模式**: 键盘模拟模式 (HID)
- **后缀**: 自动发送回车键 (CR)
- **编码**: ASCII

## API接口对应关系

| 功能 | MES接口 | 方法名 | URL路径 |
|------|---------|--------|---------|
| 获取工单 | getworkorder | GetACMesRecord | /mes/api/v1/getworkorder |
| 上传座子信息 | sendproginfo | CommitProgramerInfo2Mes | /mes/api/v1/socket |
| 上传烧录结果 | sendprogresult | CommitProgramRet2ACMes | /mes/api/v1/sendprogresult |
| 上传任务信息 | sendtaskinfo | CommitTaskInfo2Mes | /mes/sendtaskinfo |

## 错误处理

### 常见错误及解决方法

1. **"箱单条码不能为空"**
   - 原因: 用户未扫描箱单条码
   - 解决: 使用USB扫码枪扫描箱单

2. **"工程文件校验值不匹配"**
   - 原因: 本地工程文件与MES期望的不一致
   - 解决: 确认工程文件版本正确

3. **"请先登录获取token"**
   - 原因: 未登录或token过期
   - 解决: 重新登录系统

4. **"MES未返回工程文件路径"**
   - 原因: MES数据不完整
   - 解决: 检查MES系统配置

## 日志说明

系统会自动记录以下关键信息到日志：

```
[时间] 设置MES额外参数: box_sn=BX20251118001, bat_no=BATCH001, rs_no=STATION_001, wk_no=admin
[时间] GetMesRecord, strURL=..., strBody=..., strResponse=...
[时间] MES返回批号: BATCH001
[时间] UploadProgramerInfo2Mes strURL=..., strBody=...
[时间] UploadProgramRet2Mes strURL=..., strBody=...
```

日志保存在: `Build/Log/YYYY-MM-DD/` 目录下

## 测试建议

### 1. USB扫码枪测试

1. 打开记事本测试扫码枪是否正常工作
2. 确认扫码后是否自动发送回车
3. 确认编码格式正确（ASCII）

### 2. MES接口测试

1. 使用 Test/vmes.exe 模拟MES服务器
2. 配置 Test/config.yaml 设置接口路径
3. 验证各个API的请求和响应

### 3. 完整流程测试

1. 准备测试数据（工单号、料号、箱单条码）
2. 按照操作流程完整测试一遍
3. 检查日志确认所有接口调用成功
4. 验证MES数据库中的记录

## 技术要点

### 1. USB扫码枪原理

- USB扫码枪模拟USB键盘设备
- 扫描后自动输入字符到当前焦点的输入框
- 无需特殊驱动和代码处理
- 通过标准的DDX数据绑定机制获取数据

### 2. 参数传递机制

- 通过 `SetExtraParams()` 设置参数到 `CMesInterface` 单例
- 所有后续的API调用自动包含这些参数
- 避免重复传参，减少代码耦合

### 3. JSON构建

使用 cJSON 库动态构建请求JSON:
```cpp
cJSON* RootBuild = cJSON_CreateObject();
cJSON_AddStringToObject(RootBuild, "box_sn", boxSN);
// ... 添加其他字段
char* strJson = cJSON_Print(RootBuild);
```

## 后续优化建议

1. **批号显示**: 在界面上添加控件显示MES返回的批号
2. **参数验证**: 增强对机台编号的格式验证
3. **缓存机制**: 网络失败时缓存数据，待网络恢复后重传
4. **扫码反馈**: 扫码成功后给予视觉或声音反馈
5. **多语言**: 完善英文和繁体中文界面

## 联系方式

如有问题，请联系开发团队。

