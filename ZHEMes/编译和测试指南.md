# MES客户端编译和测试指南

## 编译前检查清单

### 1. 确认文件修改
- [x] `ZHEMes/ProgCtrl/MesInterface.h` - 已添加 SetExtraParams 声明
- [x] `ZHEMes/ProgCtrl/MesInterface.cpp` - 已实现 SetExtraParams 方法
- [x] `ZHEMes/MesDlg.h` - 已添加必要的成员变量声明
- [x] `ZHEMes/MesDlg.cpp` - 已修改数据绑定和初始化

### 2. 资源文件检查
- [x] `resource.h` - 确认 `IDC_EDIT_BOX_SN` (1013) 已定义
- [x] `resource.h` - 确认 `IDC_EDITWORKOERDERICNUM` (1009) 已定义

### 3. 控件绑定
- [x] `IDC_EDITWORKORDER` → `m_strWorkOrder` (工单号)
- [x] `IDC_EDIT_METERIAL` → `m_strMaterialID` (芯片料号)
- [x] `IDC_EDIT_BOX_SN` → `m_strBoxSN` (箱单条码)
- [x] `IDC_EDITWORKOERDERICNUM` → `m_strStationId` (机台编号)

## 编译步骤

### 方法1: Visual Studio IDE
1. 打开 `ZHEMes.sln`
2. 选择配置：Debug 或 Release
3. 生成 → 生成解决方案 (Ctrl+Shift+B)
4. 检查输出窗口确认无错误

### 方法2: MSBuild 命令行
```powershell
# Debug版本
msbuild ZHEMes.sln /p:Configuration=Debug /p:Platform=Win32

# Release版本
msbuild ZHEMes.sln /p:Configuration=Release /p:Platform=Win32
```

## 常见编译错误及解决

### 错误1: E0077 此声明没有存储类或类型说明符
**原因**: MesDlg.h 中变量声明语法错误  
**解决**: 确保变量声明在正确的 public/private 区域中

### 错误2: E0135 class "CMesInterface" 没有成员 "SetExtraParams"
**原因**: 头文件未正确包含或方法未声明  
**解决**: 
- 确认 MesInterface.h 中有 SetExtraParams 声明
- 重新编译整个解决方案（清理后重新生成）

### 错误3: E0020 未定义标识符 "IDC_EDIT_BOX_SN"
**原因**: resource.h 未更新或未包含  
**解决**: 
- 确认 resource.h 中有 `#define IDC_EDIT_BOX_SN 1013`
- 确保 MesDlg.cpp 包含了 resource.h

### 错误4: E0020 未定义标识符 "m_strBoxSN"
**原因**: MesDlg.h 中缺少变量声明  
**解决**: 在 MesDlg.h 的 public 区域添加变量声明

## 清理和重新生成

如果遇到奇怪的编译错误，建议完全清理后重新编译：

```powershell
# 在 Visual Studio 中
生成 → 清理解决方案
生成 → 重新生成解决方案

# 或使用命令行
msbuild ZHEMes.sln /t:Clean
msbuild ZHEMes.sln /t:Rebuild /p:Configuration=Release /p:Platform=Win32
```

## 测试步骤

### 1. 准备测试环境

#### MES模拟服务器
```powershell
cd Test
# 修改 config.yaml 配置MES接口
.\vmes.exe
```

#### USB扫码枪
- 连接USB扫码枪到电脑
- 确认设备为HID键盘模式
- 测试扫码：打开记事本，扫描条码，确认能正常输入

### 2. 应用程序启动测试

```powershell
cd Build
.\ACComMes.exe
```

**检查项**:
- [x] 登录窗口正常显示
- [x] 输入用户名和密码能成功登录
- [x] 主界面控件正常显示

### 3. 界面功能测试

#### Step 1: 输入工单信息
1. **工单号**: 输入测试工单号（如：MO20251118001）
   - 注意：工单号会自动用作批号（bat_no）
2. **芯片料号**: 输入料号（如：IC7459S26）
3. **箱单条码**: 
   - 鼠标点击"箱单条码"输入框
   - 使用USB扫码枪扫描条码
   - 确认条码正确显示
4. **机台编号**: 输入机台编号（如：STATION_001）

#### Step 2: 获取生产任务
1. 点击"获取生产任务信息"按钮
2. 观察日志窗口输出：
   ```
   设置MES额外参数: box_sn=BX001, bat_no=MO20251118001, rs_no=STATION_001, wk_no=admin
   GetMesRecord, strURL=http://..., strBody={"mo_no":"MO20251118001","box_sn":"BX001","bat_no":"MO20251118001",...}
   ```
3. 检查MES返回信息是否正确显示：
   - 工程文件路径
   - 校验值
   - 任务文件路径
   - 确认批号已自动设置为工单号

#### Step 3: 开始批量生产
1. 点击"开始批量生产"按钮
2. 检查日志：
   ```
   UploadProgramerInfo2Mes strBody={"OrderName":"...","box_sn":"BX001","bat_no":"..."}
   ```
3. 观察烧录过程和Pass/Fail统计

#### Step 4: 批量结束
1. 等待批量完成或点击"取消批量"
2. 检查结果上传日志：
   ```
   UploadProgramRet2Mes strBody={"...","box_sn":"BX001","bat_no":"...","rs_no":"..."}
   ```

### 4. 数据验证

#### 检查MES服务器日志
```json
// getworkorder 请求
{
  "mo_no": "MO20251118001",
  "MaterialID": "IC7459S26",
  "box_sn": "BX20251118001",
  "bat_no": "MO20251118001",
  "rs_no": "STATION_001",
  "wk_no": "admin"
}

// sendproginfo 请求
{
  "OrderName": "MO20251118001",
  "MaterialID": "IC7459S26",
  "box_sn": "BX20251118001",
  "bat_no": "BATCH001",
  "rs_no": "STATION_001",
  "wk_no": "admin",
  "SiteInfo": [...]
}

// sendprogresult 请求
{
  "SiteQty": [...],
  "box_sn": "BX20251118001",
  "bat_no": "BATCH001",
  "rs_no": "STATION_001",
  "wk_no": "admin"
}
```

### 5. 异常情况测试

#### 测试用例1: 箱单条码为空
- **操作**: 不输入箱单条码，直接点击"获取生产任务信息"
- **预期**: 弹出提示"箱单条码不能为空，请使用USB扫码枪扫描！"

#### 测试用例2: 工单号为空
- **操作**: 只输入箱单条码，工单号为空，点击获取
- **预期**: 弹出提示"工单号不能为空，请确认!"

#### 测试用例3: 料号为空
- **操作**: 工单号和箱单条码都输入，料号为空
- **预期**: 弹出提示"料号不能为空"

#### 测试用例4: MES服务器无响应
- **操作**: 关闭MES模拟服务器，点击获取工单
- **预期**: 日志显示HTTP错误，不会崩溃

#### 测试用例5: 校验值不匹配
- **操作**: MES返回的校验值与本地工程文件不一致
- **预期**: 提示错误，不允许开始生产

## 日志文件位置

- **应用日志**: `Build/Log/YYYY-MM-DD/`
- **MES缓存**: `Build/Cache/`
- **配置文件**: `Build/Setting.json`

## 性能测试

### 1. 扫码响应时间
- 扫码到界面显示应 < 200ms
- 可以连续快速扫描多个条码测试

### 2. MES接口响应
- `getworkorder`: 正常 < 2秒
- `sendproginfo`: 正常 < 1秒
- `sendprogresult`: 正常 < 3秒

### 3. 内存和CPU
- 空闲状态内存占用 < 100MB
- 烧录过程CPU占用 < 50%

## 发布检查清单

在发布新版本前，请确认：

- [x] Release模式编译无警告
- [x] 所有单元测试通过
- [x] 完整业务流程测试通过
- [x] 异常情况处理正常
- [x] 日志输出完整清晰
- [x] 配置文件示例更新
- [x] 用户文档更新
- [x] 版本号更新（Version.h）

## 已知问题和注意事项

1. **USB扫码枪配置**
   - 必须配置为HID键盘模式
   - 建议配置自动发送回车
   - 如果扫码乱码，检查编码设置

2. **机台编号输入**
   - `IDC_EDITWORKOERDERICNUM` 原本用于工单IC数
   - 现在改为机台编号（字符串）
   - 注意迁移老代码时的兼容性

3. **批号来源**
   - 批号自动使用工单号的值
   - 在调用 `SetExtraParams()` 前自动赋值：`m_strBatNo = m_strWorkOrder`

4. **网络异常处理**
   - 网络失败时数据会缓存到本地
   - 需要手动触发重传或重启应用自动重传

## 技术支持

如有问题，请联系：
- 开发团队: dev@example.com
- 文档地址: D:\浙玮\20251117\ZHEMes\Docs\

